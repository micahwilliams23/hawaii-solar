---
title: "Hawaii Electricity Usage"
author: "Micah Williams"
date: "4/16/2020"
output: html_document
---

```{r setup, include=FALSE, message = F, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(janitor)
library(readxl)

new_indicators <- c('imports-crude', 'imports-distillate', 'imports-kerosene', 
                    'imports-residual_oil', 'imports-propane', 'imports-fuel_ethanol', 
                    'imports-other_refined', 'meters-total', 'sold-total', 
                    'sold-residential', 'sold-commercial', 'sold-streets',
                    'price-all', 'price-residential', 'price-commercial', 
                    'price-streets', 'sent_to_grid-total', 'generation-total',
                    'generation-steam', 'generation-diesel', 'generation-biodiesel',
                    'generation-hydro_wind', 'generation-independent', 'used-stations')

edt <- read_csv('raw-data/dbedt_honolulu.csv') %>% 
  clean_names() %>%
  slice(1:n() - 1) %>%
  mutate(indicator = new_indicators,
         ind_split = map(indicator, ~str_split(., '-')),
         cat = map_chr(ind_split, ~.[[1]][1]),
         type = map_chr(ind_split, ~.[[1]][2])) %>%
  pivot_longer(cols = x2006_01:x2019_12,
               names_to = 'dates',
               values_to = 'value') %>%
  mutate('year' = str_extract(dates, pattern = '\\d{4}'),
         'month' = str_split(dates, pattern = '_')[[1]][2],
         dates = as.Date(paste(str_replace_all(dates, c('x' = '', '_' = '-')),'01', sep='-'))) %>%
  select(-c(area, ind_split)) %>%
  select(cat, type, year, month, value, units, everything())

cap <- read_excel('raw-data/existcapacity_annual.xlsx', skip = 1) %>% 
  clean_names() %>%
  filter(state_code == 'HI')


# This file is a MESS
# read_csv('raw-data/total_load.csv', skip = 3)

read_excel('raw-data/plancapacity_annual.xlsx', skip = 1) %>% 
  clean_names() %>% 
  filter(state_code == 'HI')
```

```{r}
edt %>% filter(cat == 'sold', type != 'streets', dates >= '2015-01-01') %>%
  ggplot(aes(dates, value, 
             color = type, size = type)) +
  geom_line() +
  scale_size_manual(values = c(1.1,1.1,1.3),
                    guide = F) +
  scale_x_date(date_breaks = '1 year',
               date_labels = '%Y') +
  scale_y_continuous(breaks = seq(0,6,1.5)*10^8,labels = seq(0,600,150)) +
  expand_limits(y = 0) +
  labs(title = 'Hawaii Total Monthly Electricity Demand, Last 5 Years',
       subtitle = 'Monthly demand is cyclical, peaking around the middle of the year',
       y = 'Total Electricity (million kWh)',
       x = 'Date',
       color = 'Type') +
  theme_minimal() +
  theme(legend.position = 'top')
```

```{r}
all_power <- cap %>% 
  filter(fuel_source != 'All Sources',
         producer_type == 'Total Electric Power Industry') %>%
  group_by(year) %>%
  mutate(perc = nameplate_capacity_megawatts / sum(nameplate_capacity_megawatts))

fuel_order <- all_power %>% 
  filter(year == '2018') %>%
  arrange(desc(perc)) %>% 
  pull(fuel_source)

all_power$fuel_source <- factor(all_power$fuel_source, fuel_order)

all_power %>%
  ggplot(aes(year, perc, fill = fuel_source)) +
  # geom_col(position = 'fill', width = 1) +
  geom_area() +
  scale_fill_brewer(name = 'Fuel Source', palette = 'Paired')
```

